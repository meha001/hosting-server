{% extends "base.html" %}
{% block title %} Manage {{ app.app_name }} {% endblock %}

{% block content %}
<div class="manage-container">
  <h2><i class="fas fa-cogs"></i> Manage: {{ app.app_name }}</h2>

  <p class="site-link">
    <i class="fas fa-globe"></i> Site:
    <a href="{{ url_for('files.serve_site', site_id=app.app_id) }}" target="_blank">
      /sites/{{ app.app_id }}
    </a>
  </p>

  <!-- Сообщения -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert 
            {% if category == 'success' %}alert-success
            {% elif category == 'error' %}alert-danger
            {% elif category == 'warning' %}alert-warning
            {% else %}alert-info{% endif %}">
            <i class="fas 
              {% if category == 'success' %}fa-check-circle
              {% elif category == 'error' %}fa-times-circle
              {% elif category == 'warning' %}fa-exclamation-triangle
              {% else %}fa-info-circle{% endif %}"></i>
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Создание папки -->
  <section class="card create-folder-card">
    <h4><i class="fas fa-folder-plus"></i> Create Folder</h4>
    <form action="{{ url_for('apps.create_folder', app_id=app.app_id) }}" method="post">
      <input type="hidden" name="parent" value="{{ current_path }}">
      <input type="text" name="folder_name" placeholder="folder name" required>
      <button class="btn primary" type="submit">➕ Create</button>
    </form>
  </section>
  
  <!-- Файлы -->
  <section class="card files-card">
    <h4><i class="fas fa-folder"></i> Files</h4>
    <div class="file-list">
      {% macro render_files(files, prefix="") %}
      <ul>
        {% for file in files %}
          {% if file.is_dir %}
            <li>
              📁 <a href="{{ url_for('apps.manage_app', app_id=app.app_id, path=prefix ~ file.name) }}">
                {{ prefix }}{{ file.name }}
              </a>
              <form action="{{ url_for('apps.delete_folder', app_id=app.app_id, foldername=prefix ~ file.name) }}"
                    method="post" style="display:inline;">
                <button class="btn danger small" type="submit" onclick="return confirm('Delete folder and all its content?')">❌</button>
              </form>
              {{ render_files(file.children, prefix=prefix ~ file.name ~ "/") }}
            </li>
          {% else %}
            <li>
              📄 {{ prefix }}{{ file.name }}
              <a class="btn small" href="{{ url_for('apps.download_file', app_id=app.app_id, filename=prefix ~ file.name) }}">⬇️</a>
              <form action="{{ url_for('apps.delete_file_route', app_id=app.app_id, filename=prefix ~ file.name) }}"
                    method="post" style="display:inline;">
                <button class="btn danger small" type="submit" onclick="return confirm('Delete file?')">❌</button>
              </form>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
      {% endmacro %}

      {{ render_files(files_tree) }}
    </div>
  </section>

  <!-- Upload -->
  <section class="card upload-card">
    <h4><i class="fas fa-upload"></i> Upload Files</h4>
    <form action="{{ url_for('apps.upload_files') }}" method="post" enctype="multipart/form-data">
      <input type="hidden" name="app_id" value="{{ app.app_id }}">
      <input type="hidden" name="path" value="{{ current_path }}">
      <input type="file" name="files[]" multiple>
      
        <button class="btn primary" type="submit">
          <i class="fas fa-plus"></i> Upload
        </button>
    </form>
  </section>


  <!-- Действия -->
  <div class="actions-row">
    <a href="{{ url_for('apps.download_app', app_id=app.app_id) }}" class="btn success">
      <i class="fas fa-file-archive"></i> Download ZIP
    </a>
    <form action="{{ url_for('apps.delete_app', app_id=app.app_id) }}" method="post"
          onsubmit="return confirm('Delete the entire application?');"
          style="display:inline">
      <button class="btn danger" type="submit">
        <i class="fas fa-trash-alt"></i> Delete application
      </button>
    </form>
  </div>

  <p class="back">
    <a href="{{ url_for('apps.dashboard') }}">
      <i class="fas fa-arrow-left"></i> Back to apps list
    </a>
  </p>
</div>
{% endblock %}
